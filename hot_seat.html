<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Backgammon</title>
    <link rel="stylesheet" href="{{url_for('static', filename='gra.css')}}">
</head>
<body>
    <h1>Welcome to Backgammon</h1>
    <h2>Hot-seat mode</h2>
    <a href="vsAI.html">Play vs AI</a><br>
    <a href="multiplayer.html">Multiplayer</a>
    <div id="captured-pieces" class="captured-area">
      <h3>Captured Pieces</h3>
  </div>
  
    <div class="game-wrapper">
        <!-- Plansza Backgammon -->
        <div class="board">
          <!-- Top row: punkty 24 do 13 -->
          <div class="row top-row">
            <!-- Punkt 24: 2 białe pionki -->
            <div class="point" data-position="13">
              <span class="point-number">13</span>
              <div class="triangle" id="point-13"></div>
              <div class="piece white" data-position="13"></div>
              <div class="piece white" data-position="13"></div>
              <div class="piece white" data-position="13"></div>
              <div class="piece white" data-position="13"></div>
              <div class="piece white" data-position="13"></div>
            </div>
            <!-- Punkt 23: pusty -->
            <div class="point" data-position="14">
              <span class="point-number">14</span>
              <div class="triangle" id="point-14"></div>
            </div>
            <!-- Punkt 22: pusty -->
            <div class="point" data-position="15">
              <span class="point-number">15</span>
              <div class="triangle" id="point-15"></div>
            </div>
            <!-- Punkt 21: pusty -->
            <div class="point" data-position="16">
              <span class="point-number">16</span>
              <div class="triangle" id="point-16"></div>
            </div>
            <!-- Punkt 20: pusty -->
            <div class="point" data-position="17">
              <span class="point-number">17</span>
              <div class="triangle" id="point-17"></div>
              <div class="piece black" data-position="17"></div>
              <div class="piece black" data-position="17"></div>
              <div class="piece black" data-position="17"></div>
            </div>
            <!-- Punkt 19: 5 czarnych pionków -->
            <div class="point" data-position="18">
              <span class="point-number">18</span>
              <div class="triangle" id="point-18"></div>
              
            </div>
            <!-- Punkt 18: pusty -->
            <div class="point" data-position="19">
              <span class="point-number">19</span>
              <div class="triangle" id="point-19"></div>
              <div class="piece black" data-position="19"></div>
              <div class="piece black" data-position="19"></div>
              <div class="piece black" data-position="19"></div>
              <div class="piece black" data-position="19"></div>
              <div class="piece black" data-position="19"></div>
            </div>
            <!-- Punkt 17: 3 czarne pionki -->
            <div class="point" data-position="20">
              <span class="point-number">20</span>
              <div class="triangle" id="point-20"></div>
            </div>
            <!-- Punkt 16: pusty -->
            <div class="point" data-position="21">
              <span class="point-number">21</span>
              <div class="triangle" id="point-21"></div>
            </div>
            <!-- Punkt 15: pusty -->
            <div class="point" data-position="22">
              <span class="point-number">22</span>
              <div class="triangle" id="point-22"></div>
            </div>
            <!-- Punkt 14: pusty -->
            <div class="point" data-position="23">
              <span class="point-number">23</span>
              <div class="triangle" id="point-23"></div>
            </div>
            <!-- Punkt 13: 5 białych pionków -->
            <div class="point" data-position="24">
              <span class="point-number">24</span>
              <div class="triangle" id="point-24"></div>
              <div class="piece white" data-position="24"></div>
              <div class="piece white" data-position="24"></div>
            </div>
          </div>
          
          <div class="divider"></div>
          
          <!-- Bottom row: punkty 12 do 1 (obracany o 180°) -->
          <div class="row bottom-row">
            <!-- Punkt 12: 5 czarnych pionków -->
            <div class="point" data-position="1">
              <span class="point-number">1</span>
              <div class="triangle" id="point-1"></div>
              <div class="bottom-pieces">
                <div class="piece black" data-position="1"></div>
                <div class="piece black" data-position="1"></div>
              </div>
            </div>
            <!-- Punkt 11: pusty -->
            <div class="point" data-position="2">
              <span class="point-number">2</span>
              <div class="triangle" id="point-2"></div>
              <div class="bottom-pieces">

              </div>
            </div>
            <!-- Punkt 10: pusty -->
            <div class="point" data-position="3">
              <span class="point-number">3</span>
              <div class="triangle" id="point-3"></div>
              <div class="bottom-pieces">
                
              </div>
            </div>
            <!-- Punkt 9: pusty -->
            <div class="point" data-position="4">
              <span class="point-number">4</span>
              <div class="triangle" id="point-4"></div>
              <div class="bottom-pieces">

              </div>
            </div>
            <!-- Punkt 8: 3 białe pionki -->
            <div class="point" data-position="5">
              <span class="point-number">5</span>
              <div class="triangle" id="point-5"></div>
              <div class="bottom-pieces">

              </div>
              
            </div>
            <!-- Punkt 7: pusty -->
            <div class="point" data-position="6">
              <span class="point-number">6</span>
              <div class="triangle" id="point-6"></div>
              <div class="bottom-pieces">
                <div class="piece white" data-position="6"></div>
                <div class="piece white" data-position="6"></div>
                <div class="piece white" data-position="6"></div>
                <div class="piece white" data-position="6"></div>
                <div class="piece white" data-position="6"></div>
              </div>
            </div>
            <!-- Punkt 6: 5 białych pionków -->
            <div class="point" data-position="7">
              <span class="point-number">7</span>
              <div class="triangle" id="point-7"></div>
              <div class="bottom-pieces">
                
              </div>
            </div>
            <!-- Punkt 5: pusty -->
            <div class="point" data-position="8">
              <span class="point-number">8</span>
              <div class="triangle" id="point-8"></div>
              <div class="bottom-pieces">
                <div class="piece white" data-position="8"></div>
                <div class="piece white" data-position="8"></div>
                <div class="piece white" data-position="8"></div>
              </div>
            </div>
            <!-- Punkt 4: pusty -->
            <div class="point" data-position="9">
              <span class="point-number">9</span>
              <div class="triangle" id="point-9"></div>
              <div class="bottom-pieces">

              </div>
            </div>
            <!-- Punkt 3: pusty -->
            <div class="point" data-position="10">
              <span class="point-number">10</span>
              <div class="triangle" id="point-10"></div>
              <div class="bottom-pieces">

              </div>
            </div>
            <!-- Punkt 2: pusty -->
            <div class="point" data-position="11">
              <span class="point-number">11</span>
              <div class="triangle" id="point-11"></div>
              <div class="bottom-pieces">

              </div>
            </div>
            <!-- Punkt 1: 2 czarne pionki -->
            <div class="point" data-position="12">
              <span class="point-number">12</span>
              <div class="triangle" id="point-12"></div>
              <div class="bottom-pieces">
                <div class="piece black" data-position="12"></div>
                <div class="piece black" data-position="12"></div>
                <div class="piece black" data-position="12"></div>
                <div class="piece black" data-position="12"></div>
                <div class="piece black" data-position="12"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="bok">
        <!-- Kostki (dice) obok planszy -->
         <div>home1</div>
        <div class="dice-container">
          <div class="dice" id="die1">1</div>
          <div class="dice" id="die2">6</div>
          <h2 id="turn-indicator">Tura gracza: 1 (Białe)</h2>
        </div>
        <div>home2</div>
      </div>
      </div>
      
      <script>

     document.addEventListener('DOMContentLoaded', () => {
    console.log('Skrypt JavaScript został wczytany');
    

    let selectedPiece = null;
    let selectedPoint = null;
    let currentPlayer = "1"; // Player 1 starts
    let availableMoves = [];
    let dice1 = 0, dice2 = 0;
    let diceRolled = false;

    updateTurnIndicator(currentPlayer);

    document.querySelectorAll('.dice').forEach(die => {
    die.addEventListener('click', () => {
        if (diceRolled) {
            alert("Możesz rzucić kostką tylko raz na turę!");
            return;
        }

        // **Fetch new dice values from the server**
        fetch('/roll-dice', { method: "POST" })
            .then(response => response.json())
            .then(data => {
                dice1 = data.dice1;
                dice2 = data.dice2;
                document.getElementById("die1").textContent = dice1;
                document.getElementById("die2").textContent = dice2;
                availableMoves = [dice1, dice2, dice1 + dice2];

                diceRolled = true; // **Now dice can't be rolled again this turn**
                console.log(`Gracz ${currentPlayer} rzucił: ${dice1}, ${dice2} (dostępne ruchy: ${availableMoves.join(', ')})`);
            })
            .catch(error => console.error("Błąd podczas pobierania rzutów kostką:", error));
    });
});


    // Selecting a piece to move
    document.querySelectorAll('.piece').forEach(piece => {
        piece.addEventListener('click', (e) => {
            e.stopPropagation();
            
            const pieceColor = piece.classList.contains('white') ? "1" : "2";
            
            if (pieceColor !== currentPlayer) {
                alert("Nie możesz ruszyć pionka przeciwnika!");
                return;
            }

            const pointElem = piece.closest('.point');
            selectedPoint = parseInt(pointElem.getAttribute('data-position'));
            
            document.querySelectorAll('.point').forEach(p => p.classList.remove('selected'));
            pointElem.classList.add('selected');
            selectedPiece = piece;
            console.log(`Gracz ${currentPlayer} wybrał pionek z punktu: ${selectedPoint}`);
        });
    });

    // Handling piece movement
    document.querySelectorAll('.point').forEach(point => {
    point.addEventListener('click', () => {
        const dest = parseInt(point.getAttribute('data-position'));
        if (!selectedPiece || selectedPoint === null) {
            console.log('Najpierw wybierz pionek do przesunięcia.');
            return;
        }

        let move_value = Math.abs(selectedPoint - dest);
        console.log(`Obliczona wartość ruchu: ${move_value}`);

        if (!availableMoves.includes(move_value)) {
            alert(`Ruch nie odpowiada dostępnych wartościom kostek: ${availableMoves.join(", ")}`);
            return;
        }

        const pieceColor = selectedPiece.classList.contains('white') ? "1" : "2";

        // **Check movement direction**
        if ((pieceColor === "1" && dest >= selectedPoint) || (pieceColor === "2" && dest <= selectedPoint)) {
            alert("Nie możesz przesunąć pionka w tym kierunku!");
            return;
        }

        const bottomPiecesContainer = point.querySelector('.bottom-pieces');
        const targetContainer = bottomPiecesContainer ? bottomPiecesContainer : point;

        // **Check if the target has 2+ opponent pieces (blocked)**
        const existingPieces = targetContainer.querySelectorAll('.piece');
        if (existingPieces.length >= 2) {
            const existingPieceColor = existingPieces[0].classList.contains('white') ? "1" : "2";
            
            if (existingPieceColor !== pieceColor) {
                alert("Nie możesz wejść na pole, gdzie przeciwnik ma 2 lub więcej pionków!");
                return;
            }
        }

        // **Check if there's a single opponent piece (capture condition)**
        if (existingPieces.length === 1) {
            const existingPiece = existingPieces[0];
            const existingPieceColor = existingPiece.classList.contains('white') ? "1" : "2";

            if (existingPieceColor !== pieceColor) {
                alert("Złapano pionek przeciwnika!");
                sendPieceToCapturedArea(existingPiece);
            }
        }

        // **Check if target has space for more pieces**
        if (targetContainer.querySelectorAll('.piece').length >= 5) {
            alert("Na tym polu jest już 5 pionków. Nie można tam dodać więcej.");
            return;
        }

        if (availableMoves.includes(dice1 + dice2) && move_value !== (dice1 + dice2)) {
            console.log("Pierwszy ruch nie wykorzystał sumy kostek. Usuwam tę opcję.");
            availableMoves = availableMoves.filter(value => value !== (dice1 + dice2));
        }
        if (availableMoves.includes(dice1 + dice2) && move_value == (dice1 + dice2)) {
            availableMoves = availableMoves.filter(value => value == (dice1 + dice2));
        }
        
        fetch('/move', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ start: selectedPoint, end: dest, player: currentPlayer, move_value: move_value, dice1Python: dice1, dice2Python: dice2 })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            movePiece(selectedPiece, point);

            const idx = availableMoves.indexOf(move_value);
            if (idx !== -1) availableMoves.splice(idx, 1);

            console.log(`Pozostałe dostępne ruchy po wykonaniu: ${availableMoves.join(", ")}`);

            if (availableMoves.length === 0) {
                alert(`Tura gracza ${currentPlayer} zakończona.`);
                currentPlayer = currentPlayer === "1" ? "2" : "1";
                diceRolled = false;
                updateTurnIndicator(currentPlayer);
                alert(`Teraz ruch ma gracz ${currentPlayer}`);
            }

            selectedPiece = null;
            selectedPoint = null;
            document.querySelectorAll('.point').forEach(p => p.classList.remove('selected'));
        })
        .catch(err => console.error('Błąd:', err));
    });
});


// **Function to send captured piece to the captured area**
function sendPieceToCapturedArea(piece) {
    const capturedArea = document.getElementById("captured-pieces");
    capturedArea.appendChild(piece);
    piece.dataset.position = "captured";
}

});

// Function to move a piece
function movePiece(piece, targetPoint) {
    const bottomPiecesContainer = targetPoint.querySelector('.bottom-pieces');
    const targetContainer = bottomPiecesContainer ? bottomPiecesContainer : targetPoint;

    const rect1 = piece.getBoundingClientRect();
    const rect2 = targetContainer.getBoundingClientRect();

    const deltaX = rect2.left - rect1.left;
    const deltaY = rect2.top - rect1.top;

    piece.style.transition = 'transform 0.3s ease-in-out';
    piece.style.transform = `translate(${deltaX}px, ${deltaY}px)`;

    setTimeout(() => {
        targetContainer.appendChild(piece);
        piece.style.transition = '';
        piece.style.transform = '';
        piece.dataset.position = targetPoint.getAttribute('data-position');
    }, 300);
}
function updateTurnIndicator(currentPlayer) {
    const turnIndicator = document.getElementById("turn-indicator");
    if (currentPlayer === "1") {
        turnIndicator.textContent = "Tura gracza: 1 (Białe)";
    } else {
        turnIndicator.textContent = "Tura gracza: 2 (Czarne)";
    }
}
   

      </script>
      
      
      
    </body>
    </html>